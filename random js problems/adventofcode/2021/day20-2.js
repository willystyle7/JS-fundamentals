// https://adventofcode.com
// Start again with the original input image and apply the image enhancement algorithm 50 times.
// How many pixels are lit in the resulting image?

function solve(enhancement, matrix) {
    enhancement = enhancement.replace(/\./g, '0').replace(/#/g, '1');
    // console.log(enhancement);
    matrix = matrix.split('\n').map(r => r.split('').map(e => e.replace('.', '0').replace('#', '1')));
    // console.log(matrix);

    function makeRound(outside) {
        let newMatrix = [];
        for (let i = -1; i < matrix.length + 1; i++) {
            let row = [];
            for (let j = -1; j < matrix[0].length + 1; j++) {
                row.push(transformCell(i, j, outside));
            }
            newMatrix.push(row);
        }
        matrix = newMatrix;
    }

    function transformCell(row, col, outside) {
        let bin = getMatrixEl(row - 1, col - 1, outside) + getMatrixEl(row - 1, col, outside) + getMatrixEl(row - 1, col + 1, outside)
                + getMatrixEl(row, col - 1, outside) + getMatrixEl(row , col, outside) + getMatrixEl(row, col + 1, outside)
                + getMatrixEl(row + 1, col - 1, outside) + getMatrixEl(row + 1, col, outside) + getMatrixEl(row + 1, col + 1, outside);
        let idx = parseInt(bin, 2);
        return enhancement[idx];
    }

    function getMatrixEl(row, col, outside) {
        return (matrix[row] && matrix[row][col]) || outside;
    }

    function getNextOutside(outside) {
        if (outside === '0') return enhancement[0];
        if (outside === '1') return enhancement[511];
    }
    function countLights() {
        let count = 0;
        for (let i = 0; i < matrix.length; i++) {
            for (let j = 0; j < matrix[0].length; j++) {
                if (matrix[i][j] === '1') {
                    count++;
                }
            }
        }
        return count;
    }

    let rounds = 50;
    let outside = '0';
    for (let round = 0; round < rounds; round++) {
        makeRound(outside);
        outside = getNextOutside(outside);
    }
    // console.log(matrix);

    let lights = countLights();
    return lights;
}

let enhancement = `..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#`;
let matrix =
`#..#.
#....
##..#
..#..
..###`;

console.log(solve(enhancement, matrix)); // 3351

let enhancement1 = `#..#.#######.##...##.##.#.#..#..#.....####...####.##.###...##.####......##.###.##...#..##..#.######...###..########.#.##.#.#..#..##.##..####.###.###..#...##.##.###.....###..###....#.####.#..##....#.##...##.#..#.....###.#..#.....##..##.#.#.....#....####.#.#.#....#.#...#.##...#.#.#....#.#.#....##.#.####.##..#####.####.#.####..#...###.###..##...#..###.####...#..#.####.###.##..##....#.####....#.#..##.#..#.##.##..#......###.#...#..#.#.#.##.######.##.##..####.##..#.###.##.....##...#.....#..#....###..####.#.##..#.`;
let matrix1 =
`#.#...#.....#..#.#....#.#.###.......###.###...##...#..#..###.###...##...#.#####...##..##.#.#..##....
##.####...#.#.#.##.##....###.##..##..#.##....#.####.#.#####.#..............#.###...#..#####.#....###
#.#...#..#.##..#.#.#.##.##..####..####.#..#####.#.....#####..#.##..####.#.....#.#..##..##....##.#.#.
.#..##.##.#######....####.##..######..##...#...#####....##.######.##..#..##.#.#.#.#..#....#.##.###.#
...#.###.##..##..##.#..###..#.#..#..#...#..........##..##.##..#.#...##.#.#.#.#...##.#..##.....##.##.
...##.#.#..####..#.##.#.#....#.#..#####.#..#.#.#.##..###.##..###.##...###.##.#...#.##.##........##..
#..#.#......#..##.#......#..##..#.#.#.....#.#####.##...#......#.#...##.###.#.#.#.#..###..#.##.#.....
#.#..##.#.###...#.##.#.##..########.####.#.#...##.#.##....#.....#...#..##.####.#...##.#.##.#.#...#.#
##.....#.###...##....#...##.####.####..#....##.#.#.##...#.#######.#.####.##.#.##.##.....##.####.#...
#.#.##.###.#...##.#.#.###..#.#.#..##.######..#.##......#..##..###.#.#...#...###.#.#..#.##.###..#..##
#####....#####.......##.#.#...###.##.###..##.##....#.####.####..........####.#...#....####..##.#####
.#.#..#.#...#.#..#..##.#.#.#...##.....##.###.#.#......#.#.#.##..#..###..#.#..#.###...###.#.#.#.#.#.#
#.#..###..##.#.#.#...##.####..##....#.##.#.#...#..#...#..#..#..##....#.......#######.#.##...#.###.##
#..#..#####...##.###.#.#.#.#....#..#.####.####...#..#.##.####.####.###.#.##.#..##.#.##.##.#.#...##.#
..#.###...#.####...##..#.###....##.#..#..#.#.#....##...####.##..#.#.##...##.......#.#..#..##.#.##...
#...##.##..#...#.###.#.#.##..##...####.##.#.#..#....#####....##.#####..#####.#..##.#.....##.###..##.
..#..###..#.#.########.#######..######...##.##.##..##...####..##....#....##..#...##...#.####.#...##.
.......##.#.#...##.#..#.##.#..##.##..#......#####.#....#..#..#####....#.#..#.##.##.#.#..###..##.####
.#...##..######.#...##.#######.####.####...#.####......###.#.#.#.###..#...#.#..#.#..##...#..##.#.#.#
####.#.####..#..#...#..####.#......####...###....##########...####.#...#...#.###..###.....#....#..#.
...#.##.....###...##.#..##.....#..##.##........##.####.##..#...#..######...##.#....##..#..#######.#.
##.##..#...#....#.........###.........##...#........#.#.###..#...#.#.##....#.......#....##.##..#####
.######.##..####...#...#.##..####...#######.###...#.#.#...##.#......###..#..#.#.#...##........##.##.
.#.##.##.....#......##.##.#.##..##....##..#####.........#.##........#..######.##.#.#......#.....##.#
#.#.######.#..##.#.##..#.###..#.#..##...###.###...#.#.......#.##...#.#..#....###..####.##..#.#.##.#.
.#..#...#.#..#.......###...#.##.####..##.#......#..#.#..####.#.#...###.##.#.....#...###.#....###.##.
#..##.#...##..####.#.##..#..####.##.###.....###..#.####.##.#####...######.#.###.###.##.######..#..#.
######.#.#.#.#..#.##.#......###......##..#....#...#..##...#..#.##..#.#####.######...##..#.##..###.##
#..##...#.#..#..##.####....#.#..##.###...##..#####.##.#....###.......#.#.#.#......##.##.#..#.#.#.#.#
.#..#..#.######.#.....##.#.#...#....#########....########...##...##.#..#.###.##.#..#..#######.#.##..
..##...##.###..##......#...#..#....#....###..##.#..###.#...##.#..#.####.#.##...#..####.....##..##...
#.##...###...#...#.##..#.....##.###.##...#.#..#.##.#..###..#.##.##.....#.##..#.####..#.#.#..###.##.#
#...#..#.#...##.#..##.##.#..##.#...###...###...#..###..########.####.###.#.....#..#..###.#.##...#.##
#.##.######.####...#.#...###.#..#...#.#.###.##.#...##...##.##.###.##.####..#.#####...#....###....##.
#...#.#.##.#.#..###..#.#..##.##..###..#.#.#..#..#..####.##..##.#..#..............#.###.##.#.#..#####
##.#..#.##...#....####.##....#..##.###......#..##....##########.#.###...#.##...#..##.#....#...#.####
#..#.#...#.#..#....##.##...###.....####..#..##.##.####..#.#.#.######..#...##...#.........##.#.####..
.#..#.#.#....#.#...##..#.#.##.##.....######...###.##.##.##.#..###...##.#.....##.##..#..####..###..#.
.#.##..##....#.###.#...##....#..#.########.##.#.#..#######...##.#.###.#.###...###.#..###.....####...
#.##...#...###.####.###.#.##.#.##..#..#.####...###..###..#...##...#.#.#..###.#.#####.#######.###.###
##.#####.#..##.#..#.##.##..........######.#.###.###.#...##..##..#.......##..#.##.##.###.####......##
#.###..##....#.###...#...#.#..###...##.###.###.####.##..#####.#...#.####...##..######....#...#.#####
.#.#.####....#####...#...###..#...#.....###..###.##.#.....#..#.#.#.##..##.....##.....###.#...#.####.
##....##..#..#.##..##..#.#.#.#...#.#......##.#..#.##.#..#.###..#.#.#..##......####...#..#.##..####..
##..#.##.........######.#..##...#.##.###.#.#######.##...#.#####...#........######....#.#.####...#.##
##.#.......##.#...#.....#.#.####.#.##.##...#.##.#..#.#.##..###.#..##....#...##..##.##.#.##.#....#...
...#######...#..####..#.###.#.##..#.....#..##...###.....###.....##...##.#.......##.#.#.#.##....####.
.##.##...#...####.......##...##.##..#...###.#.#...#.####.##.#.######...#.#..###.##..####.##.##...#..
.#######.###.##...#.####...#.......#.#..##.##.#####.#.#....#..###.#.##...#.###...#...##.#..###......
##.#..#...##.####.#.###.####.#.##.#.##.......###..#####.#..#..###.####.#..#....#..#..##..#...#.##.#.
.#..###.##....##..##.######..#####..##.##....#.####....#.#.###...##...#######....####.#.##...##.#..#
#.###.##.....#...#..#..###..##.#..#..##.##.#...#...#.#....#......#.#.##.#.##.##...##.##.##.#....#.#.
..#.#.###.#..#.#.##.#.#..#.#.#.#.##...#.##..######.##.#####...#...##..#.###.##...#.#.#..#.#######.##
###.######..###...#.#.##.....###.......##.##.#........##..##...##.#.#.#.##.###.##.##..#......##..###
.#..#.#.##...#..##......###....#..##.#..##.##..##....###....##.#..##...###..##..#.####..##...#######
##.#..####..##....#..####..#.#.##..###...##.#.#...##.#..###.##..###.####.##.#.###..#...#.##.#...#.##
...#..#.....#...#...###..####.##....#.##.##.#...###.#..#####.#.##.#..#..##......#..##.##..###.#...##
.#..#..########.#...#.####..#.#..#..#..####...##.#.####.#.#...#.#.###..#####.###.....####.#..#.#.#..
...#.#####.###.#..#.##.#.#...#.##....#####..##.##..############.#.##..#.#.....###.#.############....
..#..#....#..#..##.######..###...##..#.....##.#.##....#..####.#...#..##.....##..##.###.##.#..#######
#..#..##......#...####.####.##...######.#..##...###..#.#.#########..###.#.##.#.##.#...#.####.##...#.
.##.#...###.###..#.##...#...#..##.#....#.#....###.###.##.####.#.#.#..#....#.##.###..#...##..#...#.##
..##..#...##.#..#...#....#....###.##.##.##...##..####..#####.###.#.#....#.##....###.#....##...###.##
######.........#..#...####.#.......#.#####.#..#....#.#.####.#####...##..#####..###.#.#.##.###...#.##
...#.#...#.#..####.##....##.##.##.##...#...#..##..######.####..##.#.#..##..##.##...##.#...######....
.##..####..#.........####....##....#..##...#####....#.#...#......##.#.#.##...###..##.##..####..####.
#####...#.##...#######.#.######..##.....#..##...#..###.###..####.####.#####.#..#...##.....##.###..#.
##........#...#..#....#.###.##....#..#..###.#..##.#####.##....#.#..#.#..##.##...##.#....##..##.###..
###.#..#.###.#.###.###.#....##....#.#..##..####.###.##...##.##.#...#...#.....#####....###.#.##.##.##
.#...#....#.#...#.####..#..#...###..##.#..##.......##...##.##.#..#.#..##.##..##..###..##....##.#...#
###.#.#...#..#..###.#.#.##.....#..##...#.#....##.##.....###.####......####....#..##..#.#....#.##.#..
........#..#.#.##.##...#...#.#.##...##.#..#..#.#.##.####.###..######.##...#...#.##.#.###..##.#..##..
....##.#####.#.##.#.....#.#.###....#.###...#.####.##.##.#.########.##.#..##.#.##.##########.#..#...#
#..........###.####..#.....##....#.##.##..###.##........#..#...###.#..#..##.#.#.###.#.##.####..#####
#...#..##...#.#..#...###.#...#..#.###...###..#....####.##.###..#.#...##...##.#..#.###...#..###...###
####.###....####.#..#....#.#...##.#.######..#..#...##....#.#######...####..#.##......#...#..###..#..
##.#.#####.###.#...#.##..######..#...#.#####..#.##.#.#.##.###....######.#.....#..##..##..#...##..#..
.#########.##.##...#.#...##.###.#....###.#......#....##.##.#..####..##..##..#.##..#...#########....#
##....##.##..###....#...#..#...#.##.##..#######.#.##..##.#.#..#.###.##.###.#.#.#.##.#...##.######.#.
.##.#.#.#####.##...#.##...#...#..####.##..#.######..##.#.#.#....#...#..#.####.#..#..#.#...##.....###
..##.##..#........#........#.#.#.##.#....####....##....##.##...##.#.#...####.##.#####.....##.#.#.#..
#..####.#....##.###.#######..#...#..##.#...##..##.#.##..##.#.##.#.#...#.#.###.#..#.##.###..#.#....#.
#....#...#..##.##.####.#..#..####...#.#.#...#######...##..##...#.#.########...#..##.##.#...#.###.###
...##..##.##.###..###...#.####..#.....##.#..#.....##....##.#.####..#..#...##..#.#..#######.##.#...##
###...#...##.##.#...#..##.#####.######.###....###........#.##......#.###...###.#.#.##.#####..####.#.
.#########.#####....##.##..#.####.##..####.#...#.###.##.##..####.##..###......#...##..#.#.###.#..##.
.#.###..###....#####.#......#.###......###########..####.#......##.#..#..##..#.#.....#.#...#.##.##.#
..###...#.#.###....#..#####.#.###.###..#.#.#.#..#..##...#..###..#####...#.###.#.##.#.##.##.#.......#
.###..#.##..#..#.##.....#....##..#.#........##.##.########.....###..#....########.#.##.##..#.......#
.#.#..#####..###.#..#...#..#.##..###..#.###.#.##...#..###.#.#.#.##...####.####.#...#..#.###..#.###.#
#.#..##..#...###.#..####...#..#..##.###...###.##.#...#.#......##..##.#####.####....#...##.#..#..##.#
#....#...####.....#.##.#....#.#.##..#....##..####....#..###...#.#.##.#....#.###.###.....#.....#.#.##
#.##.#...#..#...########...#...##...###.##..###..#..##.#.#.#####.#....###.#..#..#.#.#...###.#.##.###
..##.#.###.#..##.#.##..##.##..##.....#..#....#.##.#...###.###....##..####..##....##.###.###.....#..#
#.##.###...##..##...#......#.#..#.......##.#.#.##.##..#....###.#..#.##.###.##....#.##....#.##.###..#
.##..#....#.#...#.###.#.##.#.##....####.######.#.#....##.##.....#.##.####..#.......##..##.#.##.....#
.###.##.....#...#.#..#.#..#..#...###.........#######.#..#######...#...#...#..######.#..#####.###....
#.....#..#....#####.....#....##.#.##..###..##..###.##..#.##..###....#.##...#####.#.#..#.##..##..#.#.
#.#..#....#.#...###.###.##...#.######.##.###..#..#..##.#.##.##.###..####..#..#..#..#...###..##.#..##
....#.###....#.#..##.#.##..#.###..#.#.##..#.#..##.#########..#.###...#.#.#....#.....####...#...##..#`;

console.log(solve(enhancement1, matrix1)); // 19743

